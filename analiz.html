<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ä°ki Tip ArasÄ± Dinamik Ä°letiÅŸim SimÃ¼latÃ¶rÃ¼</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Inter font for modern look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        
        :root {
            font-family: 'Inter', sans-serif;
        }
        
        /* TÃ¼m Ã§Ä±ktÄ± bloklarÄ± iÃ§in temel yapÄ± (Senaryo, Ã‡Ã¶zÃ¼m, Analiz) */
        .speech-bubble, .result-block-container {
            padding: 1rem 1.5rem; /* KonuÅŸma balonlarÄ±na daha fazla yatay dolgu */
            border-radius: 0.75rem;
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease-in-out;
            margin-bottom: 1rem;
        }

        /* SENARYO DÄ°YALOGLARI */
        .speech-bubble-sender {
            background-color: #eef2ff; /* Indigo-50 */
            border-left: 5px solid #6366f1; /* Indigo-500 */
        }
        .speech-bubble-receiver {
            background-color: #f0fdf4; /* Green-50 */
            border-left: 5px solid #10b981; /* Green-500 */
        }

        /* ANALÄ°Z/Ã‡Ã–ZÃœM Ã‡IKTILARI Ä°Ã‡Ä°N YENÄ° STÄ°L (Diyalog Kutusu Benzeri) */
        .result-block-container {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        /* Ã‡Ã¶zÃ¼m Bloku - YeÅŸil Tema */
        .solution-block {
            background-color: #f0fdf4; /* Green-50 */
            border-left: 6px solid #059669; /* Green-600 */
        }
        .solution-block h4 {
            color: #059669;
        }

        /* Analiz Bloku - Mor Tema */
        .analysis-block {
            background-color: #f5f3ff; /* Purple-50 */
            border-left: 6px solid #8b5cf6; /* Purple-500 */
        }
        .analysis-block h4 {
            color: #8b5cf6;
        }

        /* Analiz Ä°Ã§indeki BaÅŸlÄ±klar (Markdown Ã§Ä±ktÄ±larÄ± iÃ§in) - GÃœNCELLENDÄ° */
        .analysis-block h5, .solution-block h5 {
            font-weight: bold;
            font-size: 1.125rem; /* text-lg */
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            padding: 0.5rem 0;
            border-bottom: 2px solid rgba(139, 92, 246, 0.4); /* Mor alt Ã§izgi */
            color: #4f46e5; /* Ä°ndigo Tonu */
            display: flex;
            align-items: center;
        }
        
        .solution-block h5 {
            border-bottom: 2px solid rgba(5, 150, 105, 0.4); /* YeÅŸil alt Ã§izgi */
            color: #059669;
        }
        
        /* Listeler ve Maddeler */
        .analysis-block ul, .solution-block ul {
            list-style: disc;
            margin-left: 1.5rem;
            padding-left: 0.5rem;
            margin-top: 0.5rem;
        }
        
        /* Ã‡atÄ±ÅŸma Dinamikleri iÃ§in Diyalog Stilini taklit eden blok */
        .conflict-dynamic-block {
            background-color: #ffe4e6; /* Red-100 */
            border-left: 4px solid #f43f5e; /* Rose-500 */
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            margin-bottom: 1rem;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .dynamic-speaker {
            font-weight: bold;
            color: #be185d; /* Rose-700 */
        }

        /* Ã‡Ã¶zÃ¼m DiyaloglarÄ± Ä°Ã§in Konteyner Stili */
        .solution-dialogue-container {
            border: 1px dashed #a7f3d0; /* Green-200 */
            padding: 1rem;
            border-radius: 0.5rem;
            background-color: #ecfdf5; 
            margin-top: 1rem;
            margin-bottom: 1rem;
        }

        /* Tip KartÄ± Stili */
        .type-card {
            border-radius: 12px;
            box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease;
        }
        .type-card-header {
            padding: 1rem;
            border-radius: 12px 12px 0 0;
        }
        .type-card-body {
            padding: 1.5rem;
            background-color: #ffffff;
        }

        /* Custom spinner for loading state */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 p-4 sm:p-8 min-h-screen flex flex-col items-center">

    <div class="max-w-4xl w-full bg-white shadow-2xl rounded-xl p-6 md:p-10 border border-gray-100 mt-8 mb-8">
        <h1 class="text-3xl md:text-4xl font-extrabold text-gray-800 mb-6 border-b pb-2 flex items-center">
            <span class="mr-2 text-yellow-500">âœ¨</span> Ä°ki Tip ArasÄ± Dinamik Ä°letiÅŸim SimÃ¼lasyonu
        </h1>
        
        <!-- Tip SeÃ§im AlanÄ± -->
        <div class="bg-indigo-50 border border-indigo-200 p-5 rounded-lg mb-8 shadow-inner">
            <p class="font-semibold text-indigo-700 mb-4 text-center">Ä°letiÅŸim Dinamiklerini AyarlayÄ±n</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="sender-type" class="block text-sm font-medium text-gray-700">Tip 1 (GÃ¶nderici):</label>
                    <select id="sender-type" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                        <!-- SeÃ§enekler JS ile doldurulacak -->
                    </select>
                </div>
                <div>
                    <label for="receiver-type" class="block text-sm font-medium text-gray-700">Tip 2 (AlÄ±cÄ±):</label>
                    <select id="receiver-type" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                        <!-- SeÃ§enekler JS ile doldurulacak -->
                    </select>
                </div>
            </div>
            
            <button id="generate-scenario-button" class="mt-6 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 shadow-lg flex items-center justify-center disabled:opacity-50">
                <span class="mr-2">âš¡</span> Ä°letiÅŸim Senaryosu OluÅŸtur
            </button>
        </div>

        <!-- DÄ°YALOG VE SENARYO ALANI -->
        <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center border-b pb-2">
            <span class="mr-2 text-gray-400">ğŸ’¬</span> Senaryo Sonucu
        </h2>
        
        <div id="dialogue-area" class="min-h-[150px] space-y-4 mb-8 bg-gray-50 p-4 rounded-lg border border-gray-200">
            <div id="initial-dialogue">
                <p class="text-gray-500 italic text-center p-4">
                    LÃ¼tfen yukarÄ±dan iki Enneagram tipi seÃ§in ve **Ä°letiÅŸim Senaryosu OluÅŸtur** dÃ¼ÄŸmesine tÄ±klayÄ±n.
                </p>
            </div>
        </div>

        <!-- YENÄ° LLM ARAÃ‡LARI -->
        <h3 class="text-2xl font-bold text-gray-800 mb-4 flex items-center border-b pb-2">
            <span class="mr-2 text-yellow-600">ğŸ› ï¸</span> Analiz ve Ã‡Ã¶zÃ¼m AraÃ§larÄ±
        </h3>
        
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
            <button id="solve-button" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 shadow-md flex items-center justify-center disabled:opacity-50">
                <span class="mr-2">ğŸ¤</span> Alternatif Ã‡Ã¶zÃ¼m Ã–nerisi Ãœret
            </button>
            <button id="analyze-button" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 shadow-md flex items-center justify-center disabled:opacity-50">
                <span class="mr-2">ğŸ”</span> Derinlemesine Analiz (Grounding)
            </button>
        </div>

        <!-- ANALÄ°Z/Ã‡Ã–ZÃœM SONUÃ‡ ALANI -->
        <div id="result-area" class="min-h-[100px] bg-white border border-gray-200 rounded-lg p-4 transition-all duration-300 mb-10">
            <p id="placeholder-text" class="text-gray-500 italic">Analiz ve Ã‡Ã¶zÃ¼m araÃ§larÄ±nÄ± kullanmak iÃ§in Ã¶nce bir senaryo oluÅŸturun.</p>
            <div id="loading-spinner" class="hidden flex justify-center items-center h-full">
                <div class="spinner"></div>
            </div>
            <div id="analysis-content" class="hidden text-gray-800">
                <!-- LLM sonuÃ§larÄ± buraya yerleÅŸtirilecek -->
            </div>
        </div>
        
        <!-- EMPATÄ°K Ã‡EVÄ°RÄ° ALANI -->
        <h3 class="text-2xl font-bold text-gray-800 mb-4 flex items-center border-b pb-2">
            <span class="mr-2 text-pink-500">ğŸ’¬</span> Empatik Diyalog Ã‡evirici
        </h3>

        <div class="bg-pink-50 border border-pink-200 rounded-lg p-5">
            <p class="text-sm text-gray-700 mb-3">OluÅŸturulan senaryodan rahatsÄ±z edici bir cÃ¼mleyi kopyalayÄ±p buraya yapÄ±ÅŸtÄ±rÄ±n ve Gemini'nin daha empatik bir karÅŸÄ±lÄ±k Ã¶nermesini izleyin.</p>
            
            <textarea id="dialogue-input" rows="3" class="w-full p-3 mb-4 border border-pink-300 rounded-lg focus:ring-pink-500 focus:border-pink-500" placeholder="Ã–rn: 'Bu bÃ¼tÃ§e tablosunu yeniden yapmalÄ±yÄ±z, sÃ¼tunlarÄ±n hepsi yanlÄ±ÅŸ hizada.'"></textarea>

            <button id="translate-button" class="w-full bg-pink-600 hover:bg-pink-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 shadow-md flex items-center justify-center disabled:opacity-50">
                <span class="mr-2">ğŸ§ </span> Empatik Tona Ã‡evir
            </button>

            <div id="translation-result-area" class="mt-4 p-4 min-h-[50px] bg-white border border-pink-300 rounded-lg hidden">
                <h4 class="font-bold text-pink-700 mb-2">Empatik Ã‡eviri Sonucu:</h4>
                <p id="translation-output" class="text-gray-700 italic">SonuÃ§ bekleniyor...</p>
            </div>
            <div id="translation-loading-spinner" class="hidden flex justify-center items-center h-full mt-4">
                <div class="spinner"></div>
            </div>
            <p id="translation-error-message" class="text-red-600 mt-2 hidden">Hata oluÅŸtu.</p>
        </div>
    </div>

    <!-- ENNEAGRAM TÄ°P KARTLARI BÃ–LÃœMÃœ -->
    <div class="max-w-4xl w-full mt-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center border-b pb-2">
            <span class="mr-2 text-indigo-600">ğŸ“–</span> SeÃ§ilen Enneagram Tiplerinin DetaylarÄ±
        </h2>
        
        <div id="type-cards-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Tip kartlarÄ± buraya JS ile yÃ¼klenecek -->
        </div>
    </div>

    <!-- Firebase ve Gemini API Ä°STEMCÄ° KODU -->
    <script type="module">
        // Firebase ModÃ¼lleri
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // UI Elementleri (Genel)
        const senderTypeSelect = document.getElementById('sender-type');
        const receiverTypeSelect = document.getElementById('receiver-type');
        const dialogueArea = document.getElementById('dialogue-area');
        const placeholderText = document.getElementById('placeholder-text');
        const loadingSpinner = document.getElementById('loading-spinner');
        const analysisContent = document.getElementById('analysis-content');

        // UI Elementleri (Butonlar)
        const generateScenarioButton = document.getElementById('generate-scenario-button');
        const solveButton = document.getElementById('solve-button');
        const analyzeButton = document.getElementById('analyze-button');
        
        // UI Elementleri (Ã‡eviri)
        const dialogueInput = document.getElementById('dialogue-input');
        const translateButton = document.getElementById('translate-button');
        const translationResultArea = document.getElementById('translation-result-area');
        const translationOutput = document.getElementById('translation-output');
        const translationLoadingSpinner = document.getElementById('translation-loading-spinner');
        const translationErrorMessage = document.getElementById('translation-error-message');

        // Sabitler
        const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";
        const API_KEY = ""; // Canvas tarafÄ±ndan saÄŸlanacaktÄ±r
        
        // Enneagram Tipleri Verisi
        const ENNEAGRAM_TYPES = [
            { id: 1, name: "Reformcu", motivation: "DoÄŸru ve dÃ¼rÃ¼st olmak, mÃ¼kemmellik.", fear: "Hata yapmak, kusurlu olmak.", color: "red-700", icon: "âš–ï¸", headerBg: "bg-red-100", details: "Temel Arzu: KusursuzluÄŸa ulaÅŸmak, erdemli olmak. Temel Korku: YanlÄ±ÅŸ, kusurlu veya kÃ¶tÃ¼ olmak. Stres (4'e Gider): Kendi duygusal ihtiyaÃ§larÄ±na odaklanÄ±r, dramatikleÅŸebilir. GeliÅŸim (7'ye Gider): Daha spontane ve neÅŸeli olur, eylem odaklÄ±dÄ±r." },
            { id: 2, name: "YardÄ±msever", motivation: "Sevilmek, ilgi gÃ¶rmek, baÅŸkalarÄ±na hizmet etmek.", fear: "Sevilmemek, istenmemek.", color: "pink-700", icon: "â¤ï¸", headerBg: "bg-pink-100", details: "Temel Arzu: Sevilmek, baÅŸkalarÄ± tarafÄ±ndan takdir edilmek. Temel Korku: Sevilmemek, muhtaÃ§ gÃ¶rÃ¼nmek. Stres (8'e Gider): KontrolcÃ¼ ve baskÄ±n olabilir, Ã¶fkesini dÄ±ÅŸa vurur. GeliÅŸim (4'e Gider): Kendi ihtiyaÃ§larÄ±na odaklanÄ±r, duygusal olarak daha dÃ¼rÃ¼st olur." },
            { id: 3, name: "BaÅŸarÄ±cÄ±", motivation: "DeÄŸerli ve takdir edilmek, baÅŸarÄ±lÄ± olmak.", fear: "DeÄŸersiz olmak, baÅŸarÄ±sÄ±z olmak.", color: "yellow-700", icon: "ğŸ†", headerBg: "bg-yellow-100", details: "Temel Arzu: DeÄŸerli ve etkileyici olmak. Temel Korku: DeÄŸersiz veya baÅŸarÄ±sÄ±z olmak. Stres (9'a Gider): Ä°ÅŸleri yavaÅŸlatabilir, motivasyonunu kaybedebilir. GeliÅŸim (6'ya Gider): Daha iÅŸbirlikÃ§i ve sorumlu, gÃ¼venilir olur." },
            { id: 4, name: "Bireysel", motivation: "EÅŸsiz ve anlamlÄ± olmak, derin duygusal deneyim.", fear: "Ã–nemsiz olmak, kusurlu olmak.", color: "purple-700", icon: "ğŸ­", headerBg: "bg-purple-100", details: "Temel Arzu: Kendini ve dÃ¼nyayÄ± anlamak, otantik olmak. Temel Korku: Kimliksiz veya sÄ±radan olmak. Stres (2'ye Gider): BaÅŸkalarÄ±na aÅŸÄ±rÄ± baÄŸÄ±mlÄ± olabilir, ilgi Ã§ekmek iÃ§in fedakarlÄ±k yapar. GeliÅŸim (1'e Gider): Daha objektif ve eyleme odaklÄ±, duygusallÄ±ktan uzaklaÅŸÄ±r." },
            { id: 5, name: "AraÅŸtÄ±rmacÄ±", motivation: "Yetkin ve yeterli olmak, bilgi birikimi.", fear: "Yetersiz olmak, tÃ¼kenmek.", color: "teal-700", icon: "ğŸ§ ", headerBg: "bg-teal-100", details: "Temel Arzu: DÃ¼nyayÄ± anlamak, yetkin olmak. Temel Korku: Yetkisiz, bilgisiz veya kapasitesi tÃ¼kenmiÅŸ olmak. Stres (7'ye Gider): AÅŸÄ±rÄ± aktivite, daÄŸÄ±nÄ±klÄ±k ve dikkat daÄŸÄ±nÄ±klÄ±ÄŸÄ± yaÅŸar. GeliÅŸim (8'e Gider): Daha kararlÄ±, eyleme dÃ¶nÃ¼k ve dÃ¼nyayla etkileÅŸim kuran biri olur." },
            { id: 6, name: "SorgulayÄ±cÄ±", motivation: "GÃ¼venli ve desteklenmiÅŸ olmak, rehberlik.", fear: "Desteksiz kalmak, yolunu ÅŸaÅŸÄ±rmak.", color: "blue-700", icon: "ğŸ›¡ï¸", headerBg: "bg-blue-100", details: "Temel Arzu: GÃ¼venli ve emniyette olmak. Temel Korku: Desteksiz kalmak, tehlike. Stres (3'e Gider): Ã‡ok Ã§alÄ±ÅŸÄ±r, onaylanma arar, baÅŸarÄ± odaklÄ± olur. GeliÅŸim (9'a Gider): Daha huzurlu, kendine gÃ¼venir ve sakin kalÄ±r." },
            { id: 7, name: "Ä°stekli", motivation: "Mutlu ve tatmin olmak, seÃ§eneklere sahip olmak.", fear: "AcÄ± Ã§ekmek, mahrum kalmak.", color: "orange-700", icon: "ğŸš€", headerBg: "bg-orange-100", details: "Temel Arzu: Mutlu olmak, acÄ±dan kaÃ§Ä±nmak. Temel Korku: Mahrum kalmak, acÄ± Ã§ekmek. Stres (1'e Gider): EleÅŸtirel, yargÄ±layÄ±cÄ± ve mÃ¼kemmeliyetÃ§i olur. GeliÅŸim (5'e Gider): Daha derin, odaklanmÄ±ÅŸ ve bilgi birikimine Ã¶nem veren biri olur." },
            { id: 8, name: "Meydan Okuyan", motivation: "Kendini korumak, baÄŸÄ±msÄ±zlÄ±k, kontrol.", fear: "Kontrol edilmek, zayÄ±f gÃ¶rÃ¼nmek.", color: "indigo-700", icon: "ğŸ‘Š", headerBg: "bg-indigo-100", details: "Temel Arzu: Kendi kaderini belirlemek, gÃ¼Ã§lÃ¼ olmak. Temel Korku: Kontrol edilmek, zayÄ±f olmak. Stres (5'e Gider): Ä°Ã§ine kapanÄ±k, izole ve bilgi toplama eÄŸilimine girer. GeliÅŸim (2'ye Gider): Daha merhametli ve baÅŸkalarÄ±nÄ±n ihtiyaÃ§larÄ±na duyarlÄ± olur." },
            { id: 9, name: "BarÄ±ÅŸÃ§Ä±", motivation: "Huzurlu ve uyumlu olmak, Ã§atÄ±ÅŸmadan kaÃ§Ä±nmak.", fear: "Ã‡atÄ±ÅŸma ve ayrÄ±lÄ±k.", color: "green-700", icon: "ğŸ•Šï¸", headerBg: "bg-green-100", details: "Temel Arzu: Ä°Ã§ huzuru korumak, kabul gÃ¶rmek. Temel Korku: Ã‡atÄ±ÅŸma, ayrÄ±lÄ±k veya kayÄ±p. Stres (6'ya Gider): EndiÅŸeli, ÅŸÃ¼pheci ve gÃ¼vence arayÄ±ÅŸÄ±nda olur. GeliÅŸim (3'e Gider): Daha kararlÄ±, eyleme geÃ§er ve hedeflerine odaklanÄ±r." }
        ];

        // Firebase BaÅŸlangÄ±Ã§ AyarlarÄ±
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (Object.keys(firebaseConfig).length > 0) {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            setLogLevel('Debug');
            
            async function authenticate() {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Firebase kimlik doÄŸrulama hatasÄ±:", error);
                }
            }
            authenticate();
        }

        // UTILITY: DropdownlarÄ± doldurur
        function populateTypeSelects() {
            ENNEAGRAM_TYPES.forEach(type => {
                const optionSender = document.createElement('option');
                optionSender.value = type.id;
                optionSender.textContent = `${type.id} - ${type.name}`;
                senderTypeSelect.appendChild(optionSender);

                const optionReceiver = document.createElement('option');
                optionReceiver.value = type.id;
                optionReceiver.textContent = `${type.id} - ${type.name}`;
                receiverTypeSelect.appendChild(optionReceiver);
            });
            // VarsayÄ±lan seÃ§imler (Ã–rn: Tip 1 ve Tip 9)
            senderTypeSelect.value = 1;
            receiverTypeSelect.value = 9;
        }

        // UTILITY: SeÃ§ilen tipler deÄŸiÅŸtiÄŸinde kartlarÄ± gÃ¼nceller
        function updateTypeCards() {
            const senderType = ENNEAGRAM_TYPES.find(t => t.id == senderTypeSelect.value);
            const receiverType = ENNEAGRAM_TYPES.find(t => t.id == receiverTypeSelect.value);

            const typeCardsContainer = document.getElementById('type-cards-container');
            typeCardsContainer.innerHTML = `
                ${createTypeCardHTML(senderType, 'GÃ¶nderici (Tip 1)')}
                ${createTypeCardHTML(receiverType, 'AlÄ±cÄ± (Tip 2)')}
            `;
        }
        
        // UTILITY: Tek bir tip kartÄ± iÃ§in HTML oluÅŸturur
        function createTypeCardHTML(type, role) {
            const parts = type.details.split('. ');
            const arzu = parts.find(p => p.startsWith('Temel Arzu')) || 'Bilgi yok.';
            const korku = parts.find(p => p.startsWith('Temel Korku')) || 'Bilgi yok.';
            const stres = parts.find(p => p.startsWith('Stres')) || 'Bilgi yok.';
            const gelisim = parts.find(p => p.startsWith('GeliÅŸim')) || 'Bilgi yok.';
            
            return `
                <div class="type-card border border-gray-200">
                    <div class="type-card-header ${type.headerBg} flex justify-between items-center">
                        <h4 class="text-xl font-bold text-${type.color}">${type.icon} Tip ${type.id}: ${type.name}</h4>
                        <span class="text-sm font-semibold text-gray-600 px-3 py-1 bg-white rounded-full shadow-sm">${role}</span>
                    </div>
                    <div class="type-card-body space-y-3">
                        <p class="text-sm">
                            <span class="font-bold text-gray-700">Temel Arzu:</span> ${arzu.replace('Temel Arzu: ', '').replace('.', '')}
                        </p>
                        <p class="text-sm">
                            <span class="font-bold text-gray-700">Temel Korku:</span> ${korku.replace('Temel Korku: ', '').replace('.', '')}
                        </p>
                        <p class="text-sm border-t pt-2 border-yellow-200">
                            <span class="font-bold text-red-600">${stres.split(':')[0]}:</span> ${stres.split(':')[1]?.trim() || 'Bilgi yok.'}
                        </p>
                        <p class="text-sm border-t pt-2 border-green-200">
                            <span class="font-bold text-green-600">${gelisim.split(':')[0]}:</span> ${gelisim.split(':')[1]?.trim() || 'Bilgi yok.'}
                        </p>
                    </div>
                </div>
            `;
        }

        // Genel API Ã‡aÄŸrÄ± YardÄ±mcÄ±sÄ± (Ãœstel Geri Ã‡ekilme ile)
        async function callGeminiApi(payload, useSearch) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${API_KEY}`;
            const maxRetries = 5;
            let delay = 1000; 

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const finalPayload = {
                        ...payload,
                        tools: useSearch ? [{ "google_search": {} }] : undefined
                    };

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(finalPayload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && i < maxRetries - 1) {
                            await new Promise(resolve => setTimeout(resolve, delay));
                            delay *= 2; 
                            continue;
                        }
                        throw new Error(`API hatasÄ±: ${response.statusText}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const text = candidate.content.parts[0].text;
                        let sources = [];

                        const groundingMetadata = candidate.groundingMetadata;
                        if (useSearch && groundingMetadata && groundingMetadata.groundingAttributions) {
                            sources = groundingMetadata.groundingAttributions
                                .map(attribution => ({
                                    uri: attribution.web?.uri,
                                    title: attribution.web?.title,
                                }))
                                .filter(source => source.uri && source.title);
                        }

                        return { text, sources };
                    }
                    throw new Error("API'den geÃ§erli iÃ§erik alÄ±namadÄ±.");

                } catch (error) {
                    console.error(`Gemini API Ã§aÄŸrÄ±sÄ±nda hata (Deneme ${i + 1}):`, error);
                    if (i === maxRetries - 1) throw error; 
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
        }

        // UTILITY: JSON olarak dÃ¶nen LLM Ã§aÄŸrÄ±sÄ±
        async function callGeminiJsonApi(payload, schema) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${API_KEY}`;
            
            const finalPayload = {
                ...payload,
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: schema
                }
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(finalPayload)
            });

            if (!response.ok) { 
                throw new Error(`API hatasÄ±: ${response.statusText}`);
            }
            
            const result = await response.json();
            let jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
            
            if (jsonText) {
                // !!! HATA DÃœZELTME BURADA YAPILDI !!!
                // Regex literal (Ã–rn: /```/) yerine new RegExp kullanarak tarayÄ±cÄ± ayrÄ±ÅŸtÄ±rma hatalarÄ± Ã¶nlendi.
                // Eski hali: .replace(/```json\s*/g, '')
                
                const jsonFenceStart = new RegExp("```json\\s*", "g");
                const jsonFenceEnd = new RegExp("\\s*```", "g");
                
                jsonText = jsonText.replace(jsonFenceStart, '')
                                   .replace(jsonFenceEnd, '')
                                   .replace(/\\"/g, '"') // Unescape internal quotes
                                   .trim();

                // 2. Find the index of the first opening bracket/brace and the last closing one.
                const firstBracket = jsonText.indexOf('[');
                const firstBrace = jsonText.indexOf('{');
                let startIndex = -1;

                if (firstBracket !== -1 && (firstBrace === -1 || firstBracket < firstBrace)) {
                    startIndex = firstBracket;
                } else if (firstBrace !== -1) {
                    startIndex = firstBrace;
                }

                if (startIndex === -1) {
                    throw new Error("API'den JSON yapÄ±sÄ± bulunamadÄ± (BaÅŸlangÄ±Ã§ parantezi/kÃ¼me parantezi yok).");
                }

                const lastBracket = jsonText.lastIndexOf(']');
                const lastBrace = jsonText.lastIndexOf('}');
                let endIndex = -1;

                if (lastBracket > lastBrace) {
                    endIndex = lastBracket;
                } else if (lastBrace > lastBracket) {
                    endIndex = lastBrace;
                } else {
                    endIndex = Math.max(lastBracket, lastBrace);
                }

                if (endIndex === -1 || endIndex <= startIndex) {
                    throw new Error("API'den JSON yapÄ±sÄ± bulunamadÄ± (BitiÅŸ parantezi/kÃ¼me parantezi yok veya geÃ§ersiz aralÄ±k).");
                }

                jsonText = jsonText.substring(startIndex, endIndex + 1).trim();
                
                try {
                    return JSON.parse(jsonText);
                } catch (e) {
                    console.error("JSON ayrÄ±ÅŸtÄ±rma hatasÄ±:", e);
                    throw new Error("DÃ¼zgÃ¼n JSON formatÄ± alÄ±namadÄ± (Parsing baÅŸarÄ±sÄ±z).");
                }
            }
            throw new Error("API'den geÃ§erli iÃ§erik alÄ±namadÄ±.");
        }

        // LLM FEATURE 1: Yeni Ä°liÅŸki Senaryosu OluÅŸtur (Structured JSON Output)
        async function createNewScenario(senderType, receiverType) {
            const systemPrompt = `Sen, bir senaryo yazarÄ± ve Enneagram uzmanÄ±sÄ±n. ${senderType.name} (GÃ¶nderici) ve ${receiverType.name} (AlÄ±cÄ±) arasÄ±nda, ${senderType.motivation} ve ${receiverType.fear} dinamiklerini iÃ§eren, tipik bir Ã§atÄ±ÅŸmayÄ± anlatan 4 satÄ±rlÄ±k bir diyalog senaryosu oluÅŸtur. YANITIN SADECE Ä°STENEN JSON DÄ°ZÄ°SÄ° OLMALIDIR. BAÅLIK, AÃ‡IKLAMA VEYA EK METÄ°N KULLANMA. JSON dÄ±ÅŸÄ±nda hiÃ§bir metin Ã¼retme. JSON alanÄ±ndaki metinlerde **kalÄ±n** veya *italik* Markdown iÅŸaretleri KULLANMA.`;
            const userQuery = `Enneagram Tip ${senderType.id} (${senderType.name}) ve Tip ${receiverType.id} (${receiverType.name}) arasÄ±nda gergin bir durumu yansÄ±tan bir diyalog oluÅŸtur.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const schema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        "speaker_id": { "type": "INTEGER", "description": "KonuÅŸmacÄ±nÄ±n Enneagram Tip ID'si (Ã–rn: 1 veya 9)" },
                        "speaker_type": { "type": "STRING", "description": "KonuÅŸmacÄ±nÄ±n Enneagram Tipi ve Duygusal Durumu (Ã–rn: Tip 1 (Gergin)" },
                        "dialogue": { "type": "STRING", "description": "KonuÅŸmacÄ±nÄ±n sÃ¶zÃ¼" }
                    }
                }
            };
            
            return callGeminiJsonApi(payload, schema);
        }

        // LLM FEATURE 2: Alternatif Ã‡Ã¶zÃ¼m Ã–nerisi (Structured JSON Output with Dialogue)
        async function getAlternativeSolution(senderType, receiverType, scenarioText) {
            const systemPrompt = `Sen, Enneagram konusunda uzman bir iliÅŸki terapistisin. AmacÄ±n, verilen senaryodaki Ã§atÄ±ÅŸmayÄ± analiz etmek ve her iki tipin de temel ihtiyaÃ§larÄ±nÄ± (Tip ${senderType.id}'in temel motivasyonu: ${senderType.motivation} ve Tip ${receiverType.id}'in temel korkusu: ${receiverType.fear}) karÅŸÄ±layacak yaratÄ±cÄ±, dengeli bir uzlaÅŸma senaryosu Ã¶nermek. YANITIN SADECE Ä°STENEN JSON NESNESÄ° OLMALIDIR. Ã‡Ä±ktÄ± formatÄ±nÄ± kesinlikle takip et.`;
            const userQuery = `Bu senaryo iÃ§in uzlaÅŸma planÄ± Ã¶ner: ${scenarioText}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };
            
            const schema = {
                type: "OBJECT",
                properties: {
                    "title": { "type": "STRING", "description": "UzlaÅŸma senaryosuna kÄ±sa ve akÄ±lda kalÄ±cÄ± bir baÅŸlÄ±k (Ã–rn: 'Standartlar ve Sakinlik')." },
                    "initial_analysis": { "type": "STRING", "description": "Ã‡atÄ±ÅŸmanÄ±n temel dinamiklerinin ve her iki tipin ihtiyaÃ§larÄ±nÄ±n (markdown tablolarÄ± kullanmadan, paragraf olarak) kÄ±sa Ã¶zeti." },
                    "dialogue_scenario": { 
                        "type": "ARRAY", 
                        "description": "Tip 1 ve Tip 2'nin baÅŸarÄ±lÄ± bir uzlaÅŸma saÄŸladÄ±ÄŸÄ± 4-6 satÄ±rlÄ±k yeni diyalog.",
                        "items": {
                            "type": "OBJECT",
                            "properties": {
                                "speaker_id": { "type": "INTEGER", "description": "KonuÅŸmacÄ±nÄ±n Enneagram Tip ID'si (Ã–rn: 1 veya 9)" },
                                "speaker_type": { "type": "STRING", "description": "KonuÅŸmacÄ±nÄ±n Enneagram Tipi ve Durumu (Ã–rn: Tip 9 (Sakin ve KararlÄ±)" },
                                "dialogue": { "type": "STRING", "description": "KonuÅŸmacÄ±nÄ±n uzlaÅŸmacÄ± sÃ¶zÃ¼" }
                            },
                            "required": ["speaker_id", "speaker_type", "dialogue"]
                        }
                    },
                    "why_it_worked": { "type": "STRING", "description": "UzlaÅŸmanÄ±n neden iÅŸe yaradÄ±ÄŸÄ±nÄ±, her iki tipin de ihtiyaÃ§larÄ±nÄ±n nasÄ±l karÅŸÄ±landÄ±ÄŸÄ±nÄ± aÃ§Ä±klayan bir paragraf." }
                },
                "required": ["title", "initial_analysis", "dialogue_scenario", "why_it_worked"]
            };
            
            return callGeminiJsonApi(payload, schema);
        }

        // LLM FEATURE 3: Derinlemesine Analiz (Grounding/Search)
        async function getDeepDiveAnalysis(senderType, receiverType) {
            const systemPrompt = `Sen, Enneagram tiplerinin psikolojik derinliklerini analiz eden bir uzmansÄ±n. CevabÄ±nÄ± 4 ana baÅŸlÄ±k altÄ±nda, her baÅŸlÄ±ÄŸÄ± ayrÄ± bir satÄ±rda **kalÄ±n (bold)** ve ardÄ±ndan iki nokta Ã¼st Ã¼ste (:) kullanarak yapÄ±landÄ±r. Cevap formatÄ±: BaÅŸlÄ±k: AÃ§Ä±klama. Maddeler (listeler) iÃ§in * iÅŸareti kullan. CevabÄ±n baÅŸlangÄ±cÄ±nda ve sonunda gereksiz metinler OLMAMALIDIR. LÃ¼tfen sadece TÃ¼rkÃ§e cevap ver.`;
            const userQuery = `Enneagram Tip ${senderType.id} (${senderType.name}) ve Tip ${receiverType.id} (${receiverType.name})'in temel motivasyonlarÄ±, korkularÄ± ve bu iki tip arasÄ±ndaki bir iliÅŸkinin nasÄ±l Ã§atÄ±ÅŸmaya yol aÃ§abileceÄŸi hakkÄ±nda derinlemesine bir analiz yap.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };
            // Google Search Grounding kullanarak gÃ¼ncel ve doÄŸru bilgi al
            return callGeminiApi(payload, true);
        }

        // LLM FEATURE 4: Empatik Ã‡eviri (Text Rewriting)
        async function getToneTranslation(text) {
            const systemPrompt = "Sen, duygusal zeka ve iletiÅŸimi geliÅŸtirmede uzman bir danÄ±ÅŸmansÄ±n. Sana verilen diyaloÄŸu, anlamÄ±nÄ± deÄŸiÅŸtirmeden, alÄ±cÄ±nÄ±n duygusal ihtiyaÃ§larÄ±nÄ± gÃ¶zeten ve Ã§atÄ±ÅŸmayÄ± azaltan, empatik bir tonda yeniden yaz. CevabÄ±n sadece yeniden yazÄ±lmÄ±ÅŸ tek cÃ¼mle olmalÄ±dÄ±r.";
            const userQuery = `GiriÅŸ: '${text}' Bu cÃ¼mleyi daha empatik ve kabul edici bir tonda yeniden yaz.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };
            return callGeminiApi(payload, false);
        }

        // UTILITY: Tek bir analiz/Ã§Ã¶zÃ¼m bloÄŸu iÃ§in dÄ±ÅŸ HTML'i oluÅŸturur
        function createAnalysisBlockHTML(title, contentHTML, isSolution = false, sources = [], senderIcon = null, receiverIcon = null) {
            const blockClass = isSolution ? 'solution-block' : 'analysis-block';
            
            let sourcesHTML = '';
            if (sources.length > 0) {
                sourcesHTML = `
                    <div id="sources-area" class="mt-4 pt-2 text-xs text-gray-500 border-t border-dashed border-gray-300">
                        <p class="font-semibold mb-1">Kaynaklar (Google Arama):</p>
                        <ul id="sources-list" class="list-disc ml-4 space-y-1">
                            ${sources.map(source => `
                                <li>
                                    <a href="${source.uri}" target="_blank" class="text-indigo-600 hover:text-indigo-800 underline">
                                        ${source.title}
                                    </a>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            }
            
            const finalTitle = senderIcon && receiverIcon 
                ? `${senderIcon} ${title} ${receiverIcon}`
                : `${isSolution ? 'ğŸ¤' : 'ğŸ”'} ${title}`;

            return `
                <div class="result-block-container ${blockClass} space-y-4">
                    <h4 class="font-extrabold text-2xl mb-4 border-b pb-2">${finalTitle}</h4>
                    <div class="text-gray-800 space-y-3">
                        ${contentHTML}
                    </div>
                    ${sourcesHTML}
                </div>
            `;
        }

        // UTILITY: Metin Analiz Sonucunu Okunabilir HTML'e Ã‡evirir
        function renderAnalysisToHTML(rawText) {
            const lines = rawText.split('\n');
            let html = '';
            let inList = false;
            
            const conflictIcons = {
                "1'in EleÅŸtirisi ve 9'un Ataleti": "âš–ï¸ â†”ï¸ ğŸ•Šï¸",
                "9'un Geri Ã‡ekilmesi ve Pasif DirenÃ§": "ğŸ•Šï¸ âŒ âš–ï¸",
                "Ã–fke DÃ¶ngÃ¼sÃ¼": "ğŸ”„",
                "Ä°hmal Edilen Ã–fke": "ğŸ¤«"
            };
            
            const strategyIcons = {
                "Tip 1 Ä°Ã§in Stratejiler": "âœ… âš–ï¸",
                "Tip 9 Ä°Ã§in Stratejiler": "âœ… ğŸ•Šï¸"
            };

            lines.forEach(line => {
                line = line.trim();
                if (line.length === 0) return;
                
                // BaÅŸlÄ±k/BÃ¶lÃ¼m BaÅŸlÄ±klarÄ±
                if (line.match(/^\*\*(.*?)\*\*:(.*)$/)) {
                    if (inList) { html += '</ul>'; inList = false; }
                    
                    const match = line.match(/^\*\*(.*?)\*\*:(.*)$/);
                    const headerText = match[1].trim();
                    const content = match[2].trim();
                    let icon = '';

                    if (headerText.includes("Motivasyon")) icon = 'ğŸŒŸ';
                    else if (headerText.includes("Korku")) icon = 'ğŸ˜¨';
                    else if (headerText.includes("Ã‡atÄ±ÅŸma Dinamikleri")) icon = 'ğŸ’¥';
                    else if (headerText.includes("SaÄŸlÄ±klÄ± Ä°letiÅŸim")) icon = 'ğŸ¤';
                    
                    html += `<h5><span class="mr-2">${icon}</span> ${headerText}</h5>`;
                    
                    if (content) {
                        html += `<p class="mb-3 text-gray-700">${content.replace(/\n/g, '<br>')}</p>`;
                    }
                } 
                // Alt BaÅŸlÄ±klar/Ã‡atÄ±ÅŸma Dinamikleri
                else if (line.match(/^\*\*(.*?)\*\*$/)) {
                    if (inList) { html += '</ul>'; inList = false; }
                    const headerText = line.replace(/^\*\*(.*)\*\*$/, '$1').trim();
                    
                    let icon = conflictIcons[headerText] || strategyIcons[headerText] || 'ğŸ’¡';

                    html += `<div class="conflict-dynamic-block">
                                <p class="dynamic-speaker text-base flex items-center mb-2">
                                    <span class="text-xl mr-2">${icon}</span> ${headerText}:
                                </p>
                    `;
                }
                // Alt BaÅŸlÄ±k Kapatma ve Listeler
                else if (line.match(/^[\*\-]\s/)) {
                    if (!inList) { html += '<ul class="text-gray-700">'; inList = true; }
                    // Safe regex replacement
                    const content = line.replace(/^[\*\-]\s/, '').trim();
                    html += `<li>${content}</li>`;
                }
                // DÃ¼z metin
                else {
                    if (inList) { html += '</ul>'; inList = false; }
                    
                    if (html.endsWith('</p>')) {
                        html += `</div><p class="mb-3 text-gray-700">${line.replace(/\n/g, '<br>')}</p>`;
                    } else if (html.endsWith('</p>') || html.endsWith('</ul>')) {
                        html += `</div><p class="mb-3 text-gray-700">${line.replace(/\n/g, '<br>')}</p>`;
                    } else if (html.endsWith('</p>') || html.endsWith('</ul>') || html.endsWith('</div>')) {
                        html += `<p class="mb-3 text-gray-700">${line.replace(/\n/g, '<br>')}</p>`;
                    } else if (html.endsWith('</ul>')) {
                        html += `</div><p class="mb-3 text-gray-700">${line.replace(/\n/g, '<br>')}</p>`;
                    } else {
                        html += `<p class="mb-3 text-gray-700">${line.replace(/\n/g, '<br>')}</p>`;
                    }
                }
            });
            
            if (inList) { html += '</ul>'; }
            if (html.includes('<div class="conflict-dynamic-block">') && !html.endsWith('</div>')) {
                 html += '</div>';
            }
            
            return html;
        }

        // UTILITY: Yeni Senaryo JSON'unu HTML Diyalog AlanÄ±na Ã‡evirir
        function renderScenarioToHTML(scenarioData, senderType, receiverType) {
            let fullScenarioText = "Senaryo DiyaloÄŸu:\n";
            let html = '';
            
            scenarioData.forEach(item => {
                const speakerId = item.speaker_id;
                const speakerData = ENNEAGRAM_TYPES.find(t => t.id == speakerId) || { name: 'Bilinmeyen', color: 'gray-700', icon: 'â“' };
                const isSender = senderType.id == speakerId;
                
                const bubbleClass = isSender ? 'speech-bubble-sender' : 'speech-bubble-receiver';
                const textColor = speakerData.color;

                fullScenarioText += `${item.speaker_type}: ${item.dialogue}\n`;

                html += `
                    <div class="speech-bubble ${bubbleClass}">
                        <p class="font-bold text-lg flex items-center mb-1 text-${textColor}">
                            <span class="text-2xl mr-2">${speakerData.icon}</span> ${item.speaker_type}:
                        </p>
                        <p class="text-gray-700">
                            ${item.dialogue}
                        </p>
                    </div>
                `;
            });

            dialogueArea.innerHTML = html + `<textarea id="current-scenario-text" class="hidden">${fullScenarioText}</textarea>`;
            
            solveButton.disabled = false;
            analyzeButton.disabled = false;
        }

        // UTILITY: Ã‡Ã¶zÃ¼m JSON'unu Okunabilir HTML'e Ã‡evirir
        function renderSolutionToHTML(solutionData, senderType, receiverType) {
            let html = '';
            
            // 1. BaÅŸlangÄ±Ã§ Analizi
            html += `
                <h5 class="text-lg font-bold"><span class="mr-2">ğŸ’¡</span> Ä°lk Analiz: Ã‡atÄ±ÅŸmanÄ±n Ã–zÃ¼</h5>
                <p class="text-gray-700">${solutionData.initial_analysis}</p>
            `;
            
            // 2. Yeni Diyalog Senaryosu
            html += `
                <h5 class="text-lg font-bold"><span class="mr-2">ğŸ’¬</span> UzlaÅŸma DiyaloÄŸu: "${solutionData.title}"</h5>
                <div class="solution-dialogue-container space-y-3">
            `;
            
            solutionData.dialogue_scenario.forEach(item => {
                const speakerId = item.speaker_id;
                const speakerData = ENNEAGRAM_TYPES.find(t => t.id == speakerId) || { name: 'Bilinmeyen', color: 'gray-700', icon: 'â“' };
                const isSender = senderType.id == speakerId;
                
                const bubbleClass = isSender ? 'speech-bubble-sender' : 'speech-bubble-receiver';
                const textColor = speakerData.color;

                html += `
                    <div class="speech-bubble ${bubbleClass}">
                        <p class="font-bold text-base flex items-center mb-1 text-${textColor}">
                            <span class="text-xl mr-2">${speakerData.icon}</span> ${item.speaker_type}:
                        </p>
                        <p class="text-gray-700">
                            ${item.dialogue}
                        </p>
                    </div>
                `;
            });

            html += `</div>`; 

            // 3. Neden Ä°ÅŸe YaradÄ± Ã–zeti
            html += `
                <h5 class="text-lg font-bold"><span class="mr-2">ğŸ†</span> Neden Ä°ÅŸe YaradÄ±?</h5>
                <p class="text-gray-700">${solutionData.why_it_worked}</p>
            `;
            
            return html;
        }

        // UI GÃ¼ncelleme Fonksiyonu (Genel)
        function updateResultUI(isLoading, resultHTML = null, sources = []) {
            generateScenarioButton.disabled = isLoading;
            solveButton.disabled = isLoading;
            analyzeButton.disabled = isLoading;
            loadingSpinner.classList.toggle('hidden', !isLoading);
            
            if (isLoading) {
                placeholderText.classList.add('hidden');
                analysisContent.classList.add('hidden');
                analysisContent.innerHTML = '';
                return;
            }

            placeholderText.classList.toggle('hidden', !!resultHTML);
            analysisContent.classList.toggle('hidden', !resultHTML);
            
            if (resultHTML) {
                analysisContent.innerHTML = resultHTML;
            } else {
                 analysisContent.innerHTML = '';
            }
        }

        // UI GÃ¼ncelleme Fonksiyonu (Ã‡eviri)
        function updateTranslationUI(isLoading, resultText = null, error = false) {
            translateButton.disabled = isLoading;
            translationLoadingSpinner.classList.toggle('hidden', !isLoading);
            translationErrorMessage.classList.toggle('hidden', !error);

            if (isLoading) {
                translationResultArea.classList.remove('hidden');
                translationOutput.textContent = 'Ã‡eviri yapÄ±lÄ±yor...';
                return;
            }

            if (error) { 
                 translationResultArea.classList.add('hidden'); 
                 return;
            }

            if (resultText) {
                translationOutput.textContent = resultText.trim();
                translationResultArea.classList.remove('hidden');
            } else {
                translationResultArea.classList.add('hidden');
            }
        }

        // Olay Dinleyicileri
        senderTypeSelect.addEventListener('change', updateTypeCards);
        receiverTypeSelect.addEventListener('change', updateTypeCards);

        // 1. Ä°letiÅŸim Senaryosu OluÅŸtur
        generateScenarioButton.addEventListener('click', async () => {
            const senderType = ENNEAGRAM_TYPES.find(t => t.id == senderTypeSelect.value);
            const receiverType = ENNEAGRAM_TYPES.find(t => t.id == receiverTypeSelect.value);

            dialogueArea.innerHTML = `<div class="flex justify-center items-center h-[150px]"><div class="spinner"></div><p class="ml-4 text-indigo-600">Senaryo oluÅŸturuluyor...</p></div>`;
            solveButton.disabled = true;
            analyzeButton.disabled = true;
            updateResultUI(false); 

            try {
                const scenarioData = await createNewScenario(senderType, receiverType);
                renderScenarioToHTML(scenarioData, senderType, receiverType);
            } catch (error) {
                console.error("Yeni senaryo oluÅŸturulamadÄ±:", error);
                dialogueArea.innerHTML = `<div class="p-4 bg-red-100 border border-red-400 rounded-lg text-red-700">
                    <p class="font-bold">Senaryo OluÅŸturulamadÄ±.</p>
                    <p class="text-sm">Hata: Yapay zeka, JSON formatÄ±nÄ± doÄŸru Ã¼retemedi veya bir aÄŸ hatasÄ± oluÅŸtu. LÃ¼tfen konsolu kontrol edin.</p>
                </div>`;
            }
        });

        // 2. Alternatif Ã‡Ã¶zÃ¼m Ã–nerisi
        solveButton.addEventListener('click', async () => {
            const scenarioTextElement = document.getElementById('current-scenario-text');
            if (!scenarioTextElement) {
                const errorBox = document.getElementById('result-area');
                errorBox.innerHTML = '<p class="text-red-600 font-bold p-2">LÃ¼tfen Ã¶nce bir senaryo oluÅŸturun.</p>';
                return;
            }
            const scenarioText = scenarioTextElement.value;
            const senderType = ENNEAGRAM_TYPES.find(t => t.id == senderTypeSelect.value);
            const receiverType = ENNEAGRAM_TYPES.find(t => t.id == receiverTypeSelect.value);

            updateResultUI(true);
            try {
                const solutionData = await getAlternativeSolution(senderType, receiverType, scenarioText);
                const solutionContentHTML = renderSolutionToHTML(solutionData, senderType, receiverType);

                const solutionHTML = createAnalysisBlockHTML(
                    'Alternatif Ã‡Ã¶zÃ¼m Ã–nerisi (UzlaÅŸma PlanÄ±)',
                    solutionContentHTML,
                    true 
                );
                updateResultUI(false, solutionHTML);
            } catch (error) {
                console.error("Ã‡Ã¶zÃ¼m Ã¶nerisi alÄ±namadÄ±:", error);
                updateResultUI(false, createAnalysisBlockHTML('Hata', '<p class="text-red-600">Alternatif Ã§Ã¶zÃ¼m Ã¶nerisi alÄ±nÄ±rken bir sorun oluÅŸtu. LÃ¼tfen konsolu kontrol edin.</p>', true));
            }
        });

        // 3. Derinlemesine Analiz
        analyzeButton.addEventListener('click', async () => {
            const senderType = ENNEAGRAM_TYPES.find(t => t.id == senderTypeSelect.value);
            const receiverType = ENNEAGRAM_TYPES.find(t => t.id == receiverTypeSelect.value);

            updateResultUI(true);
            try {
                const { text, sources } = await getDeepDiveAnalysis(senderType, receiverType);
                const readableHTML = renderAnalysisToHTML(text);
                
                const analysisHTML = createAnalysisBlockHTML(
                    `Derinlemesine Analiz: Tip ${senderType.id} (${senderType.name}) ve Tip ${receiverType.id} (${receiverType.name}) Dinamikleri`,
                    readableHTML,
                    false, 
                    sources,
                    senderType.icon, 
                    receiverType.icon 
                );

                updateResultUI(false, analysisHTML);
            } catch (error) {
                console.error("Derinlemesine analiz alÄ±namadÄ±:", error);
                updateResultUI(false, createAnalysisBlockHTML('Hata', '<p class="text-red-600">Derinlemesine analiz alÄ±nÄ±rken bir sorun oluÅŸtu. LÃ¼tfen konsolu kontrol edin.</p>', false));
            }
        });
        
        // 4. Empatik Ã‡eviri
        translateButton.addEventListener('click', async () => {
            const dialogueText = dialogueInput.value.trim();
            if (!dialogueText) {
                translationErrorMessage.textContent = "LÃ¼tfen Ã§evrilecek bir diyalog metni girin.";
                updateTranslationUI(false, null, true);
                return;
            }
            
            updateTranslationUI(true);
            try {
                const { text } = await getToneTranslation(dialogueText);
                updateTranslationUI(false, text, false);
            } catch (error) {
                console.error("Empatik Ã§eviri alÄ±namadÄ±:", error);
                translationErrorMessage.textContent = "Hata: Empatik Ã§eviri alÄ±nÄ±rken bir sorun oluÅŸtu.";
                updateTranslationUI(false, null, true);
            }
        });
        
        // BaÅŸlat
        populateTypeSelects();
        updateTypeCards();

    </script>
</body>
</html>
